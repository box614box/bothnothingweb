<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æµ·å¤–æ‹¿æ€§æ•™ | The Na Xing Sect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- å…¨å±€é‡ç½® (è§£å†³æ‰‹æœºå·¦å³æ»‘åŠ¨é—®é¢˜) --- */
        * { box-sizing: border-box; }
        html, body {
            overflow-x: hidden; /* ç¦æ­¢æ¨ªå‘æ»šåŠ¨ */
            width: 100%;
            margin: 0;
            padding: 0;
        }

        /* --- å°Šè€…åœ£æ´é£ CSS (æåº¦ç´§å‡‘ç‰ˆ) --- */
        :root {
            --holy-cream: #fcfaf2;
            --warm-gold: #d4af37;
            --ink-gray: #333333;
            --light-sand: #f0eee9;
            --alert-red: #8b0000;
        }

        body {
            background-color: var(--holy-cream);
            color: var(--ink-gray);
            font-family: "Songti SC", "Noto Serif SC", "SimSun", serif;
            /* ã€æ”¹åŠ¨ã€‘æè‡´ç´§å‡‘è¡Œé«˜ */
            line-height: 1.4;
            /* ã€æ”¹åŠ¨ã€‘å­—é—´è·æ”¶ç´§ */
            letter-spacing: -0.03em; 
            text-align: center;
        }

        /* --- é¡¶éƒ¨å¤§å›¾ --- */
        .hero-banner {
            background-image: url('2.webp');
            background-size: cover;
            background-position: top center;
            height: 60vh;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            position: relative;
            padding-bottom: 40px;
            padding-right: 5%; /* æ‰‹æœºä¸Šç•™ç™½å‡å°‘ */
        }

        .hero-banner::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(212, 175, 55, 0.1), var(--holy-cream));
        }

        .hero-title {
            position: relative;
            z-index: 1;
            padding: 20px;
            text-shadow: 0 0 30px rgba(255,255,255, 0.9);
            text-align: right;
        }
        .hero-title h1 {
            font-size: 3.5rem;
            font-weight: bold;
            letter-spacing: -0.05em;
            margin-bottom: 5px;
            color: #2c2c2c;
        }
        .hero-title p {
            font-size: 1.2rem;
            font-style: italic;
            letter-spacing: 1px;
            color: #444;
            margin-top: 0;
        }

        /* --- å®¹å™¨ --- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 15px; /* å‡å°‘å†…è¾¹è· */
        }

        /* --- å®£è¨€åŒº --- */
        .scripture-text {
            font-size: 1.1rem;
            margin-bottom: 30px;
            text-align: center;
            background: white;
            padding: 40px 20px;
            border-radius: 4px;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.1);
            border-top: 4px solid var(--warm-gold);
        }
        .highlight-box {
            margin: 25px 0;
            padding: 15px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        .big-truth {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--ink-gray);
            line-height: 1.3;
        }
        .gold-text { color: var(--warm-gold); font-weight: bold; }

        .quotes-section { margin: 30px 0; }
        .quotes-btn {
            display: inline-block;
            text-decoration: none;
            color: var(--warm-gold);
            border: 1px solid var(--warm-gold);
            padding: 10px 30px;
            font-size: 1rem;
            background: transparent;
            transition: all 0.3s;
        }
        .quotes-btn:hover {
            background: var(--warm-gold);
            color: white;
        }

        /* --- åˆ†èˆµäº¤äº’åŒº --- */
        .network-section {
            background-color: white;
            padding: 40px 10px; /* æ‰‹æœºè¾¹ç¼˜ç•™ç™½å‡å°‘ */
            margin-top: 40px;
            min-height: 800px;
        }

        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 5px; /* é—´è·æ›´ç´§ */
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 8px 15px;
            border: 1px solid #ccc;
            background: white;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            border-radius: 4px;
            transition: all 0.3s;
            color: #666;
            margin-bottom: 5px; /* é˜²æ­¢æ¢è¡Œç²˜è¿ */
        }
        .tab-btn.active {
            background: var(--warm-gold);
            color: white;
            border-color: var(--warm-gold);
        }

        /* åŸå¸‚ç½‘æ ¼ */
        .branch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); /* æ›´å°çš„å¡ç‰‡ */
            gap: 8px;
            margin-bottom: 30px;
        }
        .branch-card {
            background: var(--light-sand);
            padding: 10px 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid transparent;
        }
        .branch-card:hover {
            border-color: var(--warm-gold);
            background: white;
        }
        .branch-card h3 { margin: 0; font-size: 0.95rem; color: #333; font-weight: bold; }
        .branch-card p { margin: 2px 0 0; font-size: 0.7rem; color: #888; }

        /* --- ç•™è¨€æ¿ (å‡çº§ç‰ˆ) --- */
        #supabase-board {
            display: none;
            margin-top: 20px;
            text-align: left;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .board-header {
            background: #fffdf9;
            border: 2px dashed var(--warm-gold);
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .board-title { font-size: 1.1rem; font-weight: bold; color: var(--warm-gold); }
        .close-board { cursor: pointer; color: #999; font-size: 0.85rem; border-bottom: 1px solid #999; }

        .message-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            background: #fff;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        
        /* å•æ¡æ¶ˆæ¯æ ·å¼ */
        .msg-item {
            margin-bottom: 10px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
            position: relative;
        }
        .msg-item.reply {
            margin-left: 20px; /* å›å¤ç¼©è¿› */
            background: #fafafa;
            padding: 8px;
            border-left: 3px solid #eee;
            border-bottom: none;
            margin-bottom: 5px;
        }
        .msg-meta { 
            font-size: 0.75rem; 
            color: #aaa; 
            margin-bottom: 4px; 
            display: flex;
            justify-content: space-between;
        }
        .msg-content { color: #444; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
        
        /* äº’åŠ¨æŒ‰é’® */
        .action-bar {
            margin-top: 5px;
            font-size: 0.75rem;
            color: #888;
            display: flex;
            gap: 15px;
        }
        .act-btn { cursor: pointer; display: flex; align-items: center; gap: 3px; }
        .act-btn:hover { color: var(--warm-gold); }
        .liked { color: var(--alert-red) !important; }

        /* è¾“å…¥æ¡†åŒºåŸŸ */
        .input-area-wrapper {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
        }
        .reply-tag {
            font-size: 0.8rem;
            color: var(--warm-gold);
            margin-bottom: 5px;
            display: none;
        }
        .input-area { display: flex; gap: 8px; }
        .input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 2px;
            font-family: inherit;
            font-size: 0.9rem;
        }
        .send-btn {
            background: var(--warm-gold);
            color: white;
            border: none;
            padding: 0 20px;
            cursor: pointer;
            border-radius: 2px;
            font-weight: bold;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .send-btn:hover { background: #b59020; }
        .send-btn:disabled { background: #ccc; cursor: not-allowed; }

        .truth-revelation {
            margin-top: 50px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #888;
        }

        footer {
            padding: 40px 20px;
            font-size: 0.85rem;
            color: #aaa;
            background-color: var(--light-sand);
        }

        /* --- æ‰‹æœºç‰¹å®šä¼˜åŒ– --- */
        @media screen and (max-width: 768px) {
            .hero-banner { height: 50vh; justify-content: center; padding-right: 0; align-items: flex-end; }
            .hero-title { text-align: center; padding: 15px; }
            .hero-title h1 { font-size: 2.5rem; }
            .scripture-text { padding: 30px 15px; text-align: left; }
            .branch-grid { grid-template-columns: repeat(3, 1fr); gap: 5px; }
            .tab-btn { padding: 6px 12px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <header class="hero-banner">
        <div class="hero-title">
            <h1>æ‹¿æ€§æ•™</h1>
            <p>â€œä½ ä¸æ‹¿æ€§ï¼Œæ€§å¿…æ‹¿ä½ â€</p>
        </div>
    </header>

    <div class="container">
        <div class="scripture-text">
            <h2 style="border: none; font-size: 1.6rem; margin-bottom: 20px; color: var(--warm-gold);">/// æ‹¿æ€§æ•™æ—¨ ///</h2>
            <p>ä½ æ˜¯å¦å·²ç»å‘ç°äº†é‚£ä¸ªæ®‹é…·çš„çœŸç›¸ï¼Ÿ</p>
            <p>"å‡ºå›½åï¼Œç¬¬ä¸€ä¸ªéª—ä½ çš„ï¼Œ<br>å¾€å¾€æ˜¯ä½ çš„åŒèƒã€‚"</p>
            <p>æœ¬é‚ªæ•™çš„é™ä¸´ï¼Œåªè‡´åŠ›äºåšä¸€ä»¶äº‹ï¼š</p>
            <p>åˆ›é€ æµ·å¤–åäººâ€œå‡ç»“æ ¸â€</p>
            <p>æˆ‘ä»¬éœ€è¦è¯šå®çº³ç¨çš„ä½ ï¼Œéœ€è¦æ‹¥æœ‰æ­¦å¾·çš„ä½ ï¼Œéœ€è¦ä¸å†å†·æ¼ çš„ä½ ã€‚</p>
        </div>

        <div class="quotes-section">
            <a href="quotes.html" class="quotes-btn">ğŸ“– æ­è¯»æ•™ä¸»åœ£è®­ (ç‚¹å‡»æ‚Ÿé“)</a>
        </div>
    </div>

    <div class="network-section">
        <div class="container">
            <h2 style="text-align: center; border: none; color: #2c2c2c; font-size: 1.4rem;">å…¨çƒåˆ†èˆµèµ›åšä¼ éŸ³</h2>
            <p style="text-align: center; margin-bottom: 20px; color: #888; font-size: 0.9rem;">é€‰æ‹©å¤§æ´²ï¼Œè¿›å…¥åŸå¸‚ç•™è¨€ï¼š</p>

            <div class="tabs">
                <button class="tab-btn active" onclick="showContinent('W')">å…¨çƒæ‰¯æ·¡æ€»åŒº</button>
                <button class="tab-btn active" onclick="showContinent('NA')">åŒ—ç¾</button>
                <button class="tab-btn" onclick="showContinent('EU')">æ¬§æ´²</button>
                <button class="tab-btn" onclick="showContinent('AU_NZ')">æ¾³æ–°</button>
                <button class="tab-btn" onclick="showContinent('ASIA')">äºšå¤ª/ä¸­ä¸œ</button>
                <button class="tab-btn" onclick="showContinent('SA_AF')">å—ç¾/éæ´²</button>
            </div>

            <div id="city-list" class="branch-grid"></div>

            <div id="supabase-board">
                <div class="board-header">
                    <span class="board-title" id="board-city-name">ğŸ“ åˆ†èˆµç•™è¨€æ¿</span>
                    <span class="close-board" onclick="closeBoard()">[å…³é—­]</span>
                </div>
                
                <div class="message-container" id="msg-container">
                    <p style="text-align: center; color: #ccc;">æ­£åœ¨è¿æ¥è‡³æœåŠ¡å™¨...</p>
                </div>

                <div class="input-area-wrapper">
                    <div id="reply-indicator" class="reply-tag">æ­£åœ¨å›å¤ #... <span style="cursor:pointer" onclick="cancelReply()">[å–æ¶ˆ]</span></div>
                    <div class="input-area">
                        <input type="text" id="msg-input" placeholder="åŒ¿åç•™è¨€ï¼šæœ‰é è°±åœ°æ¥å—ï¼Ÿ/ æ›å…‰éª—å­...">
                        <button class="send-btn" id="send-btn" onclick="postMessage()">å‘é€</button>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: #aaa; margin-top: 10px; text-align: center;">* æ— éœ€æ³¨å†Œï¼ŒIPä¸è®°å½•ã€‚ç‚¹å‡»â€œå›å¤â€å¯äº’åŠ¨ã€‚</p>
            </div>

            <div class="truth-revelation">
                <div class="truth-badge">âš ï¸ ç»å¯†ï¼šæ•™å›¢å†…éƒ¨å¤‡å¿˜å½• (Level 5) âš ï¸</div>
                <div class="truth-content">
                    <p><strong>å…³äºâ€œå»ºç«‹å…¨çƒåˆ†èˆµâ€çš„çœŸå®æˆ˜æœ¯æ„å›¾ï¼š</strong></p>
                    <p>â€œæ•™ä¸»åŸè¯ï¼šâ€˜æˆ‘çœŸæ­£çš„ç›®çš„æ˜¯ï¼Œä»¥åè€å­ä¸ç®¡é£åˆ°å“ªé‡Œï¼Œ<strong>è½åœ°å°±å¾—æœ‰äººæ¥æœºï¼Œåƒé¥­å°±å¾—æœ‰äººå¸¦è·¯ï¼</strong>â€™â€</p>
                    <p>â€œâ€˜è¿™æ‰æ˜¯å‡ç»“æ ¸çš„ç»ˆæå¥¥ä¹‰â€”â€”æ–¹ä¾¿æˆ‘å…¨çƒå·¡å›åƒå–ç©ä¹ï¼è°èƒ½å®‰æ’æ˜ç™½ï¼Œè°å°±æ˜¯æ ¸å¿ƒå¤§æŠ¤æ³•ï¼â€™â€</p>
                    <p style="text-align: right; margin-top: 20px; font-weight: bold;">â€”â€” æŸå¤§å½»å¤§æ‚Ÿçš„æ ¸å¿ƒå¤§å¼Ÿå­ æ•¬ä¸Š</p>
                </div>
            </div>

        </div>
    </div>

    <footer>
        <p>ä½ ä¸æ‹¿æ€§ï¼Œæ€§å¿…æ‹¿ä½ ã€‚</p>
        <p>Copyright Â© 2025 æµ·å¤–æ‹¿æ€§æ•™ | The Na Xing Sect</p>
    </footer>

    <script>
        // ============================================
        // âš ï¸ å¿…å¡«ï¼šSupabase é…ç½® 
        // ============================================
        const SUPABASE_URL = 'https://iqwslygbcydjnimtzcql.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_VefKicDVpy9mHZFp4WQYaQ_ls5tkQhn';
        // ============================================
        
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // æ•°æ®æ‰©å……ï¼šå…¨çƒæ›´å¤šåŸå¸‚
        const branches = {
            "W": [
                { name: "å¤§ç«ç®­", desc: "æ€§å­¦" }, { name: "æŠ¬å¤´æœ›è§åŒ—æå…‰", desc: "é‡‘è" }, { name: "é»„é‡‘", desc: "è¢«å›šç¦çš„è´§å¸ä¹‹ç‹" }, 
                { name: "å­å¥³æ•™è‚²", desc: "æ­£ç»" }, { name: "è¿œè¡Œä¸‰éƒ¨æ›²", desc: "æ”¹å‘½" }, { name: "é¾™è™¾æ•™æˆ", desc: "æˆåŠŸå­¦" }, 
                { name: "ç„å­¦", desc: "ç„" }  
            ],
            "NA": [
                { name: "æ¸©å“¥å", desc: "æ€»èˆµ" }, { name: "å¤šä¼¦å¤š", desc: "æå¯’éƒ¨" }, { name: "è’™ç‰¹åˆ©å°”", desc: "æ³•è¯­åŒº" }, 
                { name: "å¡å°”åŠ é‡Œ", desc: "çŸ³æ²¹éƒ¨" }, { name: "çº½çº¦", desc: "å®‡å®™ä¸­å¿ƒ" }, { name: "æ´›æ‰çŸ¶", desc: "å¤©ä½¿åŸ" }, 
                { name: "æ—§é‡‘å±±", desc: "ç¡…è°·" }, { name: "è¥¿é›…å›¾", desc: "é›¨åŸ" }, { name: "æ³¢å£«é¡¿", desc: "å­¦é™¢æ´¾" }, 
                { name: "èŠåŠ å“¥", desc: "é£åŸ" }, { name: "ä¼‘æ–¯é¡¿", desc: "èˆªå¤©åŸ" }, { name: "æ‹‰æ–¯ç»´åŠ æ–¯", desc: "èµŒéƒ¨" },
                { name: "å¤å¨å¤·", desc: "åº¦å‡éƒ¨" }
            ],
            "EU": [
                { name: "ä¼¦æ•¦", desc: "é›¾éƒ½" }, { name: "æ›¼å½»æ–¯ç‰¹", desc: "å·¥ä¸šéƒ¨" }, { name: "å·´é»", desc: "è€ä½›çˆ·" }, 
                { name: "æŸæ—", desc: "ç”µéŸ³éƒ¨" }, { name: "æ³•å…°å…‹ç¦", desc: "é‡‘èéƒ¨" }, { name: "æ…•å°¼é»‘", desc: "å•¤é…’éƒ¨" },
                { name: "é˜¿å§†æ–¯ç‰¹ä¸¹", desc: "çº¢ç¯åŒº" }, { name: "ç±³å…°", desc: "æ—¶å°šéƒ¨" }, { name: "å·´å¡ç½—é‚£", desc: "é«˜è¿ªéƒ¨" }, 
                { name: "é©¬å¾·é‡Œ", desc: "æ–—ç‰›éƒ¨" }, { name: "è‹é»ä¸–", desc: "é‡‘åº“" }, { name: "é‡Œæ–¯æœ¬", desc: "è›‹æŒéƒ¨" }
            ],
            "AU_NZ": [
                { name: "æ‚‰å°¼", desc: "æ­Œå‰§é™¢" }, { name: "å¢¨å°”æœ¬", desc: "å’–å•¡éƒ¨" }, { name: "å¸ƒé‡Œæ–¯ç­", desc: "é˜³å…‰éƒ¨" }, 
                { name: "ç€æ–¯", desc: "å­¤ç‹¬éƒ¨" }, { name: "é˜¿å¾·è±å¾·", desc: "çº¢é…’éƒ¨" }, { name: "å¥¥å…‹å…°", desc: "å¸†èˆ¹éƒ¨" }, 
                { name: "åŸºç£åŸ", desc: "èŠ±å›­éƒ¨" }, { name: "æƒ çµé¡¿", desc: "é£éƒ½" }
            ],
            "ASIA": [
                { name: "ä¸œäº¬", desc: "æ¡ˆå†…äºº" }, { name: "å¤§é˜ª", desc: "å…³è¥¿" }, { name: "åå¤å±‹", desc: "ä¸­äº¬" }, 
                { name: "é¦–å°”", desc: "æ•´å®¹éƒ¨" }, { name: "æ–°åŠ å¡", desc: "å¡å¿" }, { name: "æ›¼è°·", desc: "äº«ä¹éƒ¨" }, 
                { name: "æ¸…è¿ˆ", desc: "å…»è€éƒ¨" }, { name: "æ™®å‰å²›", desc: "æ½œæ°´éƒ¨" }, { name: "å‰éš†å¡", desc: "åŒå¡”" }, 
                { name: "è¿ªæ‹œ", desc: "åœŸè±ªéƒ¨" }
            ],
            "SA_AF": [
                { name: "å¢¨è¥¿å“¥åŸ", desc: "æ¯’æ­éƒ¨" }, { name: "åœ£ä¿ç½—", desc: "æ¡‘å·´éƒ¨" }, { name: "å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯", desc: "æ¢æˆˆéƒ¨" },
                { name: "å¼€æ™®æ•¦", desc: "å¥½æœ›è§’" }, { name: "çº¦ç¿°å†…æ–¯å ¡", desc: "é»„é‡‘éƒ¨" }
            ]
        };

        let currentCity = "";
        let replyToId = null; // å½“å‰å›å¤çš„çˆ¶ID

        // === åˆ‡æ¢å¤§æ´² ===
        function showContinent(region) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const cityContainer = document.getElementById('city-list');
            cityContainer.innerHTML = "";

            branches[region].forEach(city => {
                const div = document.createElement('div');
                div.className = 'branch-card';
                div.onclick = () => openBoard(city.name);
                div.innerHTML = `<h3>${city.name}</h3><p>${city.desc}</p>`;
                cityContainer.appendChild(div);
            });
            
            closeBoard();
        }

        // === æ‰“å¼€ç•™è¨€æ¿ ===
        async function openBoard(cityName) {
            currentCity = cityName;
            cancelReply();
            document.getElementById('board-city-name').innerText = "ğŸ“ " + cityName + " ä¼ éŸ³å£";
            document.getElementById('supabase-board').style.display = 'block';
            document.getElementById('msg-container').innerHTML = '<p style="text-align: center; color: #ccc;">æ­£åœ¨è¿æ¥è‡³æœåŠ¡å™¨...</p>';
            document.getElementById('supabase-board').scrollIntoView({behavior: "smooth"});

            fetchMessages();
        }

        // === æ‹‰å–å¹¶æ¸²æŸ“æ¶ˆæ¯ (å«å›å¤é€»è¾‘) ===
        async function fetchMessages() {
            const { data, error } = await _supabase
                .from('messages')
                .select('*')
                .eq('city', currentCity)
                .order('created_at', { ascending: true });

            const container = document.getElementById('msg-container');
            container.innerHTML = ""; 

            if (error) {
                container.innerHTML = '<p style="color:red; text-align:center;">æ— æ³•è¿æ¥è‡³æ•°æ®åº“ã€‚</p>';
                return;
            }

            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #ccc;">æ­¤å¤„å°šæ— å£°éŸ³ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªä¼ éŸ³è€…å§ã€‚</p>';
            } else {
                // æ¸²æŸ“é€»è¾‘ï¼šå…ˆæ¸²æŸ“ä¸»æ¥¼ï¼Œå†åœ¨ä¸»æ¥¼ä¸‹é¢æ¸²æŸ“å›å¤
                const rootMap = {}; // å­˜å‚¨æ‰€æœ‰æ¶ˆæ¯
                
                // 1. å…ˆæŠŠæ‰€æœ‰æ¶ˆæ¯å­˜èµ·æ¥
                data.forEach(msg => {
                    msg.children = [];
                    rootMap[msg.id] = msg;
                });

                // 2. ç»„è£…çˆ¶å­å…³ç³»
                const rootMessages = [];
                data.forEach(msg => {
                    if (msg.parent_id && rootMap[msg.parent_id]) {
                        rootMap[msg.parent_id].children.push(msg);
                    } else {
                        rootMessages.push(msg);
                    }
                });

                // 3. æ¸²æŸ“ DOM
                rootMessages.forEach(msg => {
                    container.appendChild(createMessageElement(msg, false));
                    // æ¸²æŸ“å­å›å¤
                    if (msg.children.length > 0) {
                        msg.children.forEach(child => {
                            container.appendChild(createMessageElement(child, true));
                        });
                    }
                });

                container.scrollTop = container.scrollHeight;
            }
        }

        // åˆ›å»ºæ¶ˆæ¯ DOM
        function createMessageElement(msg, isReply) {
            const div = document.createElement('div');
            div.className = isReply ? 'msg-item reply' : 'msg-item';
            const date = new Date(msg.created_at).toLocaleString();
            
            // å–œæ¬¢æ•°å¤„ç†
            const likes = msg.likes ? msg.likes : 0;

            div.innerHTML = `
                <div class="msg-meta">
                    <span>${isReply ? 'â†³ å›å¤' : 'åŒ¿åæ•™å‹'} â€¢ ${date}</span>
                    <span>#${msg.id}</span>
                </div>
                <div class="msg-content">${escapeHtml(msg.content)}</div>
                <div class="action-bar">
                    <span class="act-btn" onclick="likeMessage(${msg.id}, ${likes}, this)">
                        â¤ï¸ <span class="like-count">${likes}</span>
                    </span>
                    <span class="act-btn" onclick="prepareReply(${msg.id})">
                        ğŸ’¬ å›å¤
                    </span>
                </div>
            `;
            return div;
        }

        // === ç‚¹èµåŠŸèƒ½ ===
        async function likeMessage(id, currentLikes, btn) {
            // è§†è§‰ä¼˜åŒ–ï¼šç«‹å³+1
            const countSpan = btn.querySelector('.like-count');
            const newLikes = currentLikes + 1;
            countSpan.innerText = newLikes;
            btn.classList.add('liked');
            btn.onclick = null; // é˜²æ­¢è¿ç‚¹

            // æ•°æ®åº“æ›´æ–°
            await _supabase.from('messages').update({ likes: newLikes }).eq('id', id);
        }

        // === å‡†å¤‡å›å¤ ===
        function prepareReply(id) {
            replyToId = id;
            document.getElementById('reply-indicator').style.display = 'block';
            document.getElementById('reply-indicator').innerHTML = `æ­£åœ¨å›å¤ #${id} <span style="cursor:pointer" onclick="cancelReply()">[å–æ¶ˆ]</span>`;
            document.getElementById('msg-input').focus();
            document.getElementById('msg-input').placeholder = "è¯·è¾“å…¥å›å¤å†…å®¹...";
        }

        function cancelReply() {
            replyToId = null;
            document.getElementById('reply-indicator').style.display = 'none';
            document.getElementById('msg-input').placeholder = "åŒ¿åç•™è¨€ï¼šæœ‰é è°±åœ°æ¥å—ï¼Ÿ/ æ›å…‰éª—å­...";
        }

        // === å‘é€ç•™è¨€ ===
        async function postMessage() {
            const input = document.getElementById('msg-input');
            const btn = document.getElementById('send-btn');
            const text = input.value.trim();
            
            if (!text) return;

            btn.disabled = true;
            btn.innerText = "å‘é€ä¸­...";

            const payload = { 
                city: currentCity, 
                content: text,
                parent_id: replyToId // å¸¦ä¸Šçˆ¶ID
            };

            const { error } = await _supabase.from('messages').insert(payload);

            if (error) {
                alert("å‘é€å¤±è´¥ï¼š" + error.message);
            } else {
                input.value = "";
                cancelReply();
                // é‡æ–°æ‹‰å–åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°æ¶ˆæ¯
                await fetchMessages();
            }
            
            btn.disabled = false;
            btn.innerText = "å‘é€";
        }

        function closeBoard() {
            document.getElementById('supabase-board').style.display = 'none';
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        window.onload = function() {
            showContinent('NA');
        };
    </script>
</body>
</html>





